terraform {
  required_version = ">= 1.13.0"
  backend "s3" {}
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  alias   = "org_west"
  region  = "us-west-2"
  profile = "{{ west_profile }}"

  assume_role {
    role_arn = "arn:aws:iam::${var.target_account_id}:role/${var.target_account_role_name}"
  }
}

provider "aws" {
  alias   = "identity_center"
  region  = "us-east-1" # IAM Identity Center is a global service, but the API endpoint is in us-east-1
  profile = "{{ id_center_profile }}"
}

data "aws_ssoadmin_instances" "this" {
  provider = aws.identity_center
}

locals {
  identity_center_instance_arn = tolist(data.aws_ssoadmin_instances.this.arns)[0]
  identity_store_id            = tolist(data.aws_ssoadmin_instances.this.identity_store_ids)[0]
}

module "cicd" {
  source = "../../../modules/cicd"

  providers = {
    aws.org_west        = aws.org_west
    aws.identity_center = aws.identity_center
  }

  s3_git_bucket_name           = var.s3_git_bucket_name
  review_notification_emails   = var.review_notification_emails
  build_notification_emails    = var.build_notification_emails
  codeartifact_domain_name     = var.codeartifact_domain_name
  codeartifact_repository_name = var.codeartifact_repository_name
  codebuild_project_name       = var.codebuild_project_name
  identitystore_id             = local.identity_store_id
  iam_output_json_path         = "${path.module}/../../../.config/iam_output.json"
}

module "vpc_vpn" {
  source = "../../../modules/vpc-vpn"

  providers = {
    aws = aws.org_west
  }

  vpc_cidr_block                        = var.vpc_cidr_block
  subnet_cidr_block                     = var.subnet_cidr_block
  public_subnet_cidr_block              = var.public_subnet_cidr_block
  client_vpn_endpoint_client_cidr_block = var.client_vpn_endpoint_client_cidr_block
  cert_common_name                      = var.cert_common_name
  cert_organization                     = var.cert_organization
}

module "test_webapp" {
  source = "../../../modules/test-webapp"

  providers = {
    aws = aws.org_west
  }

  vpc_id          = module.vpc_vpn.vpc_id
  subnet_id       = module.vpc_vpn.subnet_id
  client_vpn_cidr = module.vpc_vpn.client_vpn_cidr
  vpc_cidr        = module.vpc_vpn.vpc_cidr
}

# --- Policy Aggregation and Application ---

data "local_file" "iam_output" {
  filename = "${path.module}/../../../.config/iam_output.json"
}

locals {
  groups_and_users = jsondecode(data.local_file.iam_output.content)

  # Aggregate all required policy statements from the modules
  all_developer_statements = concat(
    module.cicd.required_permission_set_statements,
    module.vpc_vpn.required_permission_set_statements
    # Add other modules' outputs here in the future
  )

  # Create a normalized prefix from the account alias to reliably find the matching permission set
  # e.g., "testProjectA_unclassified" -> "testprojecta_unclass"
  # e.g., "testProjectA_secret"      -> "testprojecta_secret"
  normalized_account_prefix = lower(replace(var.account_alias, "unclassified", "unclass"))
}

data "aws_ssoadmin_permission_set" "all" {
  provider     = aws.identity_center
  for_each     = toset(keys(local.groups_and_users.iam_permission_sets.value))
  instance_arn = tolist(data.aws_ssoadmin_instances.this.arns)[0]
  name         = each.key
}

resource "aws_ssoadmin_permission_set_inline_policy" "developer_access" {
  provider           = aws.identity_center
  # This robust filter finds the single developer permission set that starts with the account's normalized prefix
  for_each           = { for ps in data.aws_ssoadmin_permission_set.all : ps.name => ps if startswith(lower(ps.name), local.normalized_account_prefix) && endswith(lower(ps.name), "developer") }
  instance_arn       = tolist(data.aws_ssoadmin_instances.this.arns)[0]
  permission_set_arn = each.value.arn

  inline_policy = jsonencode({
    Version = "2012-10-17",
    Statement = local.all_developer_statements
  })
}